[{"type":"js","data":"//////////////////////////////////////////////////////////////////////////\n//                                                                      //\n// This is a generated file. You can view the original                  //\n// source in your browser if your browser supports source maps.         //\n// Source maps are supported by all recent versions of Chrome, Safari,  //\n// and Firefox, and by Internet Explorer 11.                            //\n//                                                                      //\n//////////////////////////////////////////////////////////////////////////\n\n\n(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar _ = Package.underscore._;\nvar Mongo = Package.mongo.Mongo;\nvar PersistentMinimongo = Package['frozeman:persistent-minimongo'].PersistentMinimongo;\nvar Web3 = Package['ethereum:web3'].Web3;\nvar BigNumber = Package['ethereum:web3'].BigNumber;\n\n/* Package-scope variables */\nvar EthAccounts;\n\n(function(){\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                    //\n// packages/ethereum_accounts/accounts.js                                                                             //\n//                                                                                                                    //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                      //\n/**                                                                                                                   // 1\n                                                                                                                      // 2\n@module Ethereum:accounts                                                                                             // 3\n*/                                                                                                                    // 4\n                                                                                                                      // 5\n                                                                                                                      // 6\n                                                                                                                      // 7\n/**                                                                                                                   // 8\nThe accounts collection, with some ethereum additions.                                                                // 9\n                                                                                                                      // 10\n@class EthAccounts                                                                                                    // 11\n@constructor                                                                                                          // 12\n*/                                                                                                                    // 13\nvar collection = new Mongo.Collection('ethereum_accounts', {connection: null});                                       // 14\nEthAccounts = _.clone(collection);                                                                                    // 15\nEthAccounts._collection = collection;                                                                                 // 16\n                                                                                                                      // 17\n                                                                                                                      // 18\nif(typeof PersistentMinimongo !== 'undefined')                                                                        // 19\n    new PersistentMinimongo(EthAccounts._collection);                                                                 // 20\n                                                                                                                      // 21\n                                                                                                                      // 22\n                                                                                                                      // 23\n/**                                                                                                                   // 24\nUpdates the accounts balances, by watching for new blocks and checking the balance.                                   // 25\n                                                                                                                      // 26\n@method _watchBalance                                                                                                 // 27\n*/                                                                                                                    // 28\nEthAccounts._watchBalance = function(){                                                                               // 29\n    var _this = this;                                                                                                 // 30\n                                                                                                                      // 31\n    if(this.blockSubscription) {                                                                                      // 32\n        this.blockSubscription.stopWatching();                                                                        // 33\n    }                                                                                                                 // 34\n                                                                                                                      // 35\n    // UPDATE SIMPLE ACCOUNTS balance on each new block                                                               // 36\n    this.blockSubscription = web3.eth.filter('latest');                                                               // 37\n    this.blockSubscription.watch(function(e, res){                                                                    // 38\n        if(!e) {                                                                                                      // 39\n            _this._updateBalance();                                                                                   // 40\n        }                                                                                                             // 41\n    });                                                                                                               // 42\n};                                                                                                                    // 43\n                                                                                                                      // 44\n/**                                                                                                                   // 45\nUpdates the accounts balances.                                                                                        // 46\n                                                                                                                      // 47\n@method _updateBalance                                                                                                // 48\n*/                                                                                                                    // 49\nEthAccounts._updateBalance = function(){                                                                              // 50\n    var _this = this;                                                                                                 // 51\n                                                                                                                      // 52\n    _.each(EthAccounts.find({}).fetch(), function(account){                                                           // 53\n        web3.eth.getBalance(account.address, function(err, res){                                                      // 54\n            if(!err) {                                                                                                // 55\n                if(res.toFixed) {                                                                                     // 56\n                    res = res.toFixed();                                                                              // 57\n                }                                                                                                     // 58\n                                                                                                                      // 59\n                EthAccounts.update(account._id, {                                                                     // 60\n                    $set: {                                                                                           // 61\n                        balance: res                                                                                  // 62\n                    }                                                                                                 // 63\n                });                                                                                                   // 64\n            }                                                                                                         // 65\n        });                                                                                                           // 66\n    });                                                                                                               // 67\n}                                                                                                                     // 68\n                                                                                                                      // 69\n/**                                                                                                                   // 70\nUpdates the accounts list,                                                                                            // 71\nif its finds a difference between the accounts in the collection and the accounts in the accounts array.              // 72\n                                                                                                                      // 73\n@method _addAccounts                                                                                                  // 74\n*/                                                                                                                    // 75\nEthAccounts._addAccounts = function(){                                                                                // 76\n    var _this = this;                                                                                                 // 77\n                                                                                                                      // 78\n    // UPDATE normal accounts on start                                                                                // 79\n    web3.eth.getAccounts(function(e, accounts){                                                                       // 80\n        if(!e) {                                                                                                      // 81\n            var visibleAccounts = _.pluck(EthAccounts.find().fetch(), 'address');                                     // 82\n                                                                                                                      // 83\n                                                                                                                      // 84\n            if(!_.isEmpty(accounts) &&                                                                                // 85\n                _.difference(accounts, visibleAccounts).length === 0 &&                                               // 86\n                _.difference(visibleAccounts, accounts).length === 0)                                                 // 87\n                return;                                                                                               // 88\n                                                                                                                      // 89\n                                                                                                                      // 90\n            var localAccounts = EthAccounts.findAll().fetch();                                                        // 91\n                                                                                                                      // 92\n            // if the accounts are different, update the local ones                                                   // 93\n            _.each(localAccounts, function(account){                                                                  // 94\n                                                                                                                      // 95\n                // needs to have the balance                                                                          // 96\n                if(!account.balance)                                                                                  // 97\n                    return;                                                                                           // 98\n                                                                                                                      // 99\n                // set status deactivated, if it seem to be gone                                                      // 100\n                if(!_.contains(accounts, account.address)) {                                                          // 101\n                    EthAccounts.updateAll(account._id, {                                                              // 102\n                        $set: {                                                                                       // 103\n                            deactivated: true                                                                         // 104\n                        }                                                                                             // 105\n                    });                                                                                               // 106\n                } else {                                                                                              // 107\n                    EthAccounts.updateAll(account._id, {                                                              // 108\n                        $unset: {                                                                                     // 109\n                            deactivated: ''                                                                           // 110\n                        }                                                                                             // 111\n                    });                                                                                               // 112\n                }                                                                                                     // 113\n                                                                                                                      // 114\n                accounts = _.without(accounts, account.address);                                                      // 115\n            });                                                                                                       // 116\n                                                                                                                      // 117\n            // ADD missing accounts                                                                                   // 118\n            var accountsCount = visibleAccounts.length + 1;                                                           // 119\n            _.each(accounts, function(address){                                                                       // 120\n                                                                                                                      // 121\n                web3.eth.getBalance(address, function(e, balance){                                                    // 122\n                    if(!e) {                                                                                          // 123\n                        if(balance.toFixed) {                                                                         // 124\n                            balance = balance.toFixed();                                                              // 125\n                        }                                                                                             // 126\n                                                                                                                      // 127\n                        web3.eth.getCoinbase(function(e, coinbase){                                                   // 128\n                            var doc = EthAccounts.findAll({                                                           // 129\n                                address: address,                                                                     // 130\n                            }).fetch()[0];                                                                            // 131\n                                                                                                                      // 132\n                            var insert = {                                                                            // 133\n                                type: 'account',                                                                      // 134\n                                address: address,                                                                     // 135\n                                balance: balance,                                                                     // 136\n                                name: (address === coinbase) ? 'Main account (Etherbase)' : 'Account '+ accountsCount\n                            };                                                                                        // 138\n                                                                                                                      // 139\n                            if(doc) {                                                                                 // 140\n                                EthAccounts.updateAll(doc._id, {                                                      // 141\n                                    $set: insert                                                                      // 142\n                                });                                                                                   // 143\n                            } else {                                                                                  // 144\n                                EthAccounts.insert(insert);                                                           // 145\n                            }                                                                                         // 146\n                                                                                                                      // 147\n                            if(address !== coinbase)                                                                  // 148\n                                accountsCount++;                                                                      // 149\n                        });                                                                                           // 150\n                    }                                                                                                 // 151\n                });                                                                                                   // 152\n                                                                                                                      // 153\n            });                                                                                                       // 154\n        }                                                                                                             // 155\n    });                                                                                                               // 156\n};                                                                                                                    // 157\n                                                                                                                      // 158\n                                                                                                                      // 159\n                                                                                                                      // 160\n/**                                                                                                                   // 161\nBuilds the query with the addition of \"{deactivated: {$exists: false}}\"                                               // 162\n                                                                                                                      // 163\n@method _addToQuery                                                                                                   // 164\n@param {Mixed} arg                                                                                                    // 165\n@param {Object} options                                                                                               // 166\n@param {Object} options.includeDeactivated If set then de-activated accounts are also included.                       // 167\n@return {Object} The query                                                                                            // 168\n*/                                                                                                                    // 169\nEthAccounts._addToQuery = function(args, options){                                                                    // 170\n    var _this = this;                                                                                                 // 171\n                                                                                                                      // 172\n    options = _.extend({                                                                                              // 173\n        includeDeactivated: false                                                                                     // 174\n    }, options);                                                                                                      // 175\n                                                                                                                      // 176\n    var args = Array.prototype.slice.call(args);                                                                      // 177\n                                                                                                                      // 178\n    if(_.isString(args[0])) {                                                                                         // 179\n        args[0] = {                                                                                                   // 180\n            _id: args[0],                                                                                             // 181\n        };                                                                                                            // 182\n    }                                                                                                                 // 183\n    else if (!_.isObject(args[0])) {                                                                                  // 184\n        args[0] = {};                                                                                                 // 185\n    }                                                                                                                 // 186\n                                                                                                                      // 187\n    if (!options.includeDeactivated) {                                                                                // 188\n        args[0] = _.extend(args[0], {                                                                                 // 189\n            deactivated: {$exists: false}                                                                             // 190\n        });                                                                                                           // 191\n    }                                                                                                                 // 192\n                                                                                                                      // 193\n    return args;                                                                                                      // 194\n};                                                                                                                    // 195\n                                                                                                                      // 196\n                                                                                                                      // 197\n/**                                                                                                                   // 198\nFind all accounts, besides the deactivated ones                                                                       // 199\n                                                                                                                      // 200\n@method find                                                                                                          // 201\n@return {Object} cursor                                                                                               // 202\n*/                                                                                                                    // 203\nEthAccounts.find = function(){                                                                                        // 204\n    return this._collection.find.apply(this, this._addToQuery(arguments));                                            // 205\n};                                                                                                                    // 206\n                                                                                                                      // 207\n/**                                                                                                                   // 208\nFind all accounts, including the deactivated ones                                                                     // 209\n                                                                                                                      // 210\n@method findAll                                                                                                       // 211\n@return {Object} cursor                                                                                               // 212\n*/                                                                                                                    // 213\nEthAccounts.findAll = function() {                                                                                    // 214\n    return this._collection.find.apply(this, this._addToQuery(arguments, {                                            // 215\n        includeDeactivated: true                                                                                      // 216\n    }));                                                                                                              // 217\n}                                                                                                                     // 218\n                                                                                                                      // 219\n/**                                                                                                                   // 220\nFind one accounts, besides the deactivated ones                                                                       // 221\n                                                                                                                      // 222\n@method findOne                                                                                                       // 223\n@return {Object} cursor                                                                                               // 224\n*/                                                                                                                    // 225\nEthAccounts.findOne = function(){                                                                                     // 226\n    return this._collection.findOne.apply(this, this._addToQuery(arguments));                                         // 227\n};                                                                                                                    // 228\n                                                                                                                      // 229\n/**                                                                                                                   // 230\nUpdate accounts, besides the deactivated ones                                                                         // 231\n                                                                                                                      // 232\n@method update                                                                                                        // 233\n@return {Object} cursor                                                                                               // 234\n*/                                                                                                                    // 235\nEthAccounts.update = function(){                                                                                      // 236\n    return this._collection.update.apply(this, this._addToQuery(arguments));                                          // 237\n};                                                                                                                    // 238\n                                                                                                                      // 239\n/**                                                                                                                   // 240\nUpdate accounts, including the deactivated ones                                                                       // 241\n                                                                                                                      // 242\n@method updateAll                                                                                                     // 243\n@return {Object} cursor                                                                                               // 244\n*/                                                                                                                    // 245\nEthAccounts.updateAll = function() {                                                                                  // 246\n    return this._collection.update.apply(this, this._addToQuery(arguments, {                                          // 247\n        includeDeactivated: true                                                                                      // 248\n    }));                                                                                                              // 249\n}                                                                                                                     // 250\n                                                                                                                      // 251\n/**                                                                                                                   // 252\nUpdate accounts, including the deactivated ones                                                                       // 253\n                                                                                                                      // 254\n@method upsert                                                                                                        // 255\n@return {Object} cursor                                                                                               // 256\n*/                                                                                                                    // 257\nEthAccounts.upsert = function() {                                                                                     // 258\n    return this._collection.upsert.apply(this, this._addToQuery(arguments, {                                          // 259\n        includeDeactivated: true                                                                                      // 260\n    }));                                                                                                              // 261\n}                                                                                                                     // 262\n                                                                                                                      // 263\n                                                                                                                      // 264\n/**                                                                                                                   // 265\nStarts fetching and watching the accounts                                                                             // 266\n                                                                                                                      // 267\n@method init                                                                                                          // 268\n*/                                                                                                                    // 269\nEthAccounts.init = function() {                                                                                       // 270\n    var _this = this;                                                                                                 // 271\n                                                                                                                      // 272\n    if(typeof web3 === 'undefined') {                                                                                 // 273\n        console.warn('EthAccounts couldn\\'t find web3, please make sure to instantiate a web3 object before calling EthAccounts.init()');\n        return;                                                                                                       // 275\n    }                                                                                                                 // 276\n                                                                                                                      // 277\n    Tracker.nonreactive(function(){                                                                                   // 278\n                                                                                                                      // 279\n        _this._addAccounts();                                                                                         // 280\n                                                                                                                      // 281\n        _this._updateBalance();                                                                                       // 282\n        _this._watchBalance();                                                                                        // 283\n                                                                                                                      // 284\n        // check for new accounts every 2s                                                                            // 285\n        Meteor.clearInterval(_this._intervalId);                                                                      // 286\n        _this._intervalId = Meteor.setInterval(function(){                                                            // 287\n            _this._addAccounts();                                                                                     // 288\n        }, 2000);                                                                                                     // 289\n                                                                                                                      // 290\n    });                                                                                                               // 291\n};                                                                                                                    // 292\n                                                                                                                      // 293\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nif (typeof Package === 'undefined') Package = {};\n(function (pkg, symbols) {\n  for (var s in symbols)\n    (s in pkg) || (pkg[s] = symbols[s]);\n})(Package['ethereum:accounts'] = {}, {\n  EthAccounts: EthAccounts\n});\n\n})();\n","servePath":"/packages/ethereum_accounts.js"}]